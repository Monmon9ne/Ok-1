<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard LuaProtector</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div class="max-w-4xl mx-auto p-6">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Dashboard</h1>
    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">Logout</button>
  </div>

  <div id="scriptsList" class="space-y-3">
    <p class="text-gray-400">Đang tải scripts...</p>
  </div>

</div>

<script>
const user = localStorage.getItem('monlua_user');

// Nếu chưa login → redirect về login
if(!user){
  window.location.href = 'login.html';
}

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('monlua_user');
  window.location.href = 'login.html';
});

// Fake load storage từ API (ở đây dùng fetch tới /api/storage giả lập)
async function loadScripts(){
  try{
    const res = await fetch('/api/storage.js'); // hoặc gọi API riêng để lấy script JSON
    // Thay bằng actual API nếu muốn fetch script theo user
    // Giả lập:
    const data = await res.json().catch(_=>({})); 
    displayScripts(data);
  }catch(e){
    console.error(e);
    document.getElementById('scriptsList').innerHTML = '<p class="text-red-400">Lỗi tải scripts</p>';
  }
}

function displayScripts(data){
  const list = document.getElementById('scriptsList');
  list.innerHTML = '';
  const names = Object.keys(data);
  if(names.length===0){
    list.innerHTML = '<p class="text-gray-400">Chưa có script nào</p>';
    return;
  }

  names.forEach(name=>{
    const script = data[name];
    const div = document.createElement('div');
    div.className='bg-gray-800 p-3 rounded-lg flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-2';
    div.innerHTML = `
      <div>
        <p class="font-semibold">${name}</p>
        <p class="text-xs text-gray-400">Created: ${script.createdAt}</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button onclick='copyText("${script.content.replace(/\u200D/g,"")}")' class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">Copy Raw</button>
        <button onclick='copyText("loadstring(game:HttpGet(\\"${window.location.origin}/api/raw/${name}\\") )()")' class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">Copy Loadstring</button>
        <button onclick='updateScript("${name}")' class="px-2 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-xs">Update</button>
        <button onclick='deleteScript("${name}")' class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
}

function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>alert('✅ Copied!'));
}

function updateScript(name){
  const newCode = prompt(`Nhập code mới cho ${name}:`);
  if(!newCode) return;
  fetch('/api/update.js', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, text:newCode})
  }).then(r=>r.json()).then(d=>{
    if(d.error) alert('❌ '+d.error);
    else { alert('✅ Updated'); loadScripts(); }
  });
}

function deleteScript(name){
  if(!confirm(`Xóa script ${name}?`)) return;
  fetch('/api/delete.js', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name})
  }).then(r=>r.json()).then(d=>{
    if(d.error) alert('❌ '+d.error);
    else { alert('✅ Deleted'); loadScripts(); }
  });
}

loadScripts();
</script>
</body>
</html>
